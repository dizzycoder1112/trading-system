# Scripts

## download_okx_history.ts

å¾ OKX ä¸‹è¼‰æ­·å² K ç·šæ•¸æ“šï¼Œç”¨æ–¼å›æ¸¬ã€‚

### ä½¿ç”¨æ–¹å¼

```bash
# åŸºæœ¬ç”¨æ³•
npx tsx scripts/download_okx_history.ts \
  --inst-id=ETH-USDT-SWAP \
  --bar=5m \
  --after=2025-10-01T00:00:00 \
  --before=2025-10-26T00:00:00

# æŒ‡å®šè¼¸å‡ºç›®éŒ„
npx tsx scripts/download_okx_history.ts \
  --inst-id=BTC-USDT-SWAP \
  --bar=5m \
  --after=2025-09-01T00:00:00 \
  --before=2025-09-30T00:00:00 \
  --output=custom/path
```

### åƒæ•¸èªªæ˜

| åƒæ•¸        | å¿…å¡« | èªªæ˜                                      | ç¯„ä¾‹                          |
| ----------- | ---- | ----------------------------------------- | ----------------------------- |
| `--inst-id` | âœ…   | äº¤æ˜“å°                                    | `ETH-USDT-SWAP`, `BTC-USDT`   |
| `--bar`     | âœ…   | Kç·šé€±æœŸ                                   | `1m`, `5m`, `15m`, `1H`, `1D` |
| `--after`   | âœ…   | é–‹å§‹æ™‚é–“ï¼ˆISO 8601ï¼‰                      | `2025-10-01T00:00:00`         |
| `--before`  | âœ…   | çµæŸæ™‚é–“ï¼ˆISO 8601ï¼‰                      | `2025-10-26T00:00:00`         |
| `--output`  | âŒ   | è¼¸å‡ºç›®éŒ„ï¼ˆé»˜èªï¼š`apps/backtesting/data`ï¼‰ | `custom/path`                 |

### è¼¸å‡ºæ ¼å¼

æ–‡ä»¶åæ ¼å¼ï¼š`{é–‹å§‹æ—¥æœŸ}-{çµæŸæ—¥æœŸ}-{é€±æœŸ}-{äº¤æ˜“å°}.json`

ç¯„ä¾‹ï¼š`20251001-20251026-5m-ETH-USDT-SWAP.json`

å…§å®¹æ ¼å¼ï¼ˆOKX API æ ¼å¼ï¼‰ï¼š

```json
{
  "code": "0",
  "msg": "",
  "data": [
    [
      "1597026383085", // æ™‚é–“æˆ³
      "3.721", // é–‹ç›¤åƒ¹
      "3.743", // æœ€é«˜åƒ¹
      "3.677", // æœ€ä½åƒ¹
      "3.708", // æ”¶ç›¤åƒ¹
      "8422410", // æˆäº¤é‡
      "22698348.04828491",
      "12698348.04828491",
      "1"
    ]
  ]
}
```

## OKX API æ–‡æª”

### GET /api/v5/market/history-candles

ç²å–æ­·å² K ç·šæ•¸æ“šï¼ˆæœ€è¿‘ 3 å€‹æœˆï¼Œ1s K ç·šï¼‰

**Rate Limit**: 20 requests per 2 seconds
**Rate limit rule**: IP

### Request Parameters

| åƒæ•¸ | é¡å‹ | å¿…å¡« | èªªæ˜ |
|------|------|------|------|
| `instId` | String | âœ… Yes | äº¤æ˜“å° IDï¼Œä¾‹å¦‚ `BTC-USDT` |
| `after` | String | âŒ No | åˆ†é åƒæ•¸ï¼Œè¿”å›æ—©æ–¼è©²æ™‚é–“æˆ³çš„æ•¸æ“š |
| `before` | String | âŒ No | åˆ†é åƒæ•¸ï¼Œè¿”å›æ™šæ–¼è©²æ™‚é–“æˆ³çš„æ•¸æ“šï¼ˆå–®ç¨ä½¿ç”¨æ™‚è¿”å›æœ€æ–°æ•¸æ“šï¼‰ |
| `bar` | String | âŒ No | K ç·šé€±æœŸï¼Œé»˜èª `1m`<br>æ”¯æŒ: `1s/1m/3m/5m/15m/30m/1H/2H/4H`<br>UTC+8: `6H/12H/1D/2D/3D/1W/1M/3M`<br>UTC+0: `6Hutc/12Hutc/1Dutc/2Dutc/3Dutc/1Wutc/1Mutc/3Mutc` |
| `limit` | String | âŒ No | æ¯æ¬¡è¿”å›æ•¸é‡ï¼Œæœ€å¤§ 300ï¼Œé»˜èª 100 |

### Response Parameters

è¿”å›æ ¼å¼ï¼šæ•¸çµ„çš„æ•¸çµ„ `[[ts, o, h, l, c, vol, volCcy, volCcyQuote, confirm], ...]`

| ç´¢å¼• | åƒæ•¸ | é¡å‹ | èªªæ˜ |
|------|------|------|------|
| [0] | `ts` | String | K ç·šé–‹ç›¤æ™‚é–“ï¼ŒUnix æ™‚é–“æˆ³ï¼ˆæ¯«ç§’ï¼‰ï¼Œä¾‹å¦‚ `1597026383085` |
| [1] | `o` | String | é–‹ç›¤åƒ¹ (Open) |
| [2] | `h` | String | æœ€é«˜åƒ¹ (High) |
| [3] | `l` | String | æœ€ä½åƒ¹ (Low) |
| [4] | `c` | String | æ”¶ç›¤åƒ¹ (Close) |
| [5] | `vol` | String | æˆäº¤é‡ï¼ˆåˆç´„å¼µæ•¸æˆ–åŸºç¤è²¨å¹£æ•¸é‡ï¼‰<br>è¡ç”Ÿå“åˆç´„ï¼šåˆç´„å¼µæ•¸<br>ç¾è²¨/æ§“æ¡¿ï¼šåŸºç¤è²¨å¹£æ•¸é‡ |
| [6] | `volCcy` | String | æˆäº¤é‡ï¼ˆåŸºç¤è²¨å¹£æˆ–è¨ˆåƒ¹è²¨å¹£æ•¸é‡ï¼‰<br>è¡ç”Ÿå“åˆç´„ï¼šåŸºç¤è²¨å¹£æ•¸é‡<br>ç¾è²¨/æ§“æ¡¿ï¼šè¨ˆåƒ¹è²¨å¹£æ•¸é‡ |
| [7] | `volCcyQuote` | String | æˆäº¤é¡ï¼ˆè¨ˆåƒ¹è²¨å¹£ï¼‰<br>ä¾‹å¦‚ BTC-USDT å’Œ BTC-USDT-SWAP çš„å–®ä½æ˜¯ USDT |
| [8] | `confirm` | String | K ç·šç‹€æ…‹<br>`0`: æœªå®Œæˆ<br>`1`: å·²å®Œæˆ |

### Request Example

```bash
GET /api/v5/market/history-candles?instId=BTC-USDT&bar=5m&limit=100
```

### æ³¨æ„äº‹é …

1. **Rate Limiting**ï¼šè…³æœ¬è‡ªå‹•è™•ç† OKX API çš„é€Ÿç‡é™åˆ¶ï¼ˆ20 requests/2 secondsï¼‰
2. **åˆ†é è™•ç†**ï¼šè‡ªå‹•åˆ†é ç²å–æ‰€æœ‰æ•¸æ“šï¼ˆæ¯æ¬¡æœ€å¤š 300 æ¢ï¼‰
3. **éŒ¯èª¤é‡è©¦**ï¼šç¶²çµ¡éŒ¯èª¤æœƒè‡ªå‹•é‡è©¦ 3 æ¬¡
4. **æ™‚é–“ç¯„åœ**ï¼šOKX æœ€å¤šæ”¯æŒæœ€è¿‘ 3 å€‹æœˆçš„ 1s K ç·šæ•¸æ“š

### ç¯„ä¾‹

ä¸‹è¼‰ ETH-USDT-SWAP 10æœˆä»½çš„ 5 åˆ†é˜ K ç·šï¼š

```bash
npx tsx scripts/download_okx_history.ts \
  --inst-id=ETH-USDT-SWAP \
  --bar=5m \
  --after=2025-10-01T00:00:00 \
  --before=2025-10-31T23:59:59
```

é æœŸè¼¸å‡ºï¼š

```
ğŸ“¥ é–‹å§‹ä¸‹è¼‰æ­·å²æ•¸æ“š...
   äº¤æ˜“å°: ETH-USDT-SWAP
   é€±æœŸ: 5m
   æ™‚é–“ç¯„åœ: 2025-10-01 00:00:00 ~ 2025-10-31 23:59:59

ğŸ“„ Page 1: è«‹æ±‚ä¸­...
   â”œâ”€ ç²å– 300 æ¢æ•¸æ“š
   â””â”€ ç´¯è¨ˆ 300 æ¢
ğŸ“„ Page 2: è«‹æ±‚ä¸­...
   â”œâ”€ ç²å– 300 æ¢æ•¸æ“š
   â””â”€ ç´¯è¨ˆ 600 æ¢
...

âœ… ç¸½å…±ä¸‹è¼‰ 8928 æ¢æ•¸æ“š
ğŸ’¾ æ•¸æ“šå·²ä¿å­˜åˆ°: apps/backtesting/data/20251001-20251031-5m-ETH-USDT-SWAP.json

âœ… å®Œæˆï¼
```

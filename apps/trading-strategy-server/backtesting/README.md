# Backtesting Engine

回測引擎 - 用於測試交易策略的歷史表現

## 功能

- 載入歷史 K 線數據
- 模擬開倉和平倉
- 計算交易指標（收益率、最大回撤、勝率等）
- 支持參數優化

## 使用方式

```bash
# 從 trading-strategy-server 目錄運行
cd apps/trading-strategy-server

# 基本使用（使用默認參數）
go run ./cmd/backtest/main.go --data=/path/to/data/xxx/history.json

# 自定義參數
go run ./cmd/backtest/main.go \
  --data=/path/to/data/20211031-20221031/ETH-USDT-SWAP/5m/history.json \
  --initial-balance=20000 \
  --position-size=200 \
  --take-profit-min=0.002 \
  --take-profit-max=0.003 \
  --break-even-profit-min=1 \
  --enable-trend-filter=false \
  --enable-red-candle-filter=true \
  --enable-auto-funding=true \
  --auto-funding-amount=5000 \
  --auto-funding-idle=288
```

> ⚠️ `--data` 參數需使用絕對路徑

查看完整參數：`go run ./cmd/backtest/main.go --help`

## 可用參數

| 參數                         | 默認值 | 說明                                           |
| ---------------------------- | ------ | ---------------------------------------------- |
| `--data`                     | (必填) | 歷史數據文件路徑                               |
| `--initial-balance`          | 10000  | 初始資金 (USDT)                                |
| `--position-size`            | 100    | 單次開倉大小 (USDT)                            |
| `--fee-rate`                 | 0.0005 | 手續費率 (taker = 0.05%)                       |
| `--take-profit-min`          | 0.0015 | 最小止盈百分比 (0.15%)                         |
| `--take-profit-max`          | 0.01   | 最大止盈百分比 (1%)                            |
| `--break-even-profit-min`    | -0.1   | 打平最小目標盈利 (USDT)                        |
| `--break-even-profit-max`    | 20.0   | ⚠️ Deprecated，目前未使用                      |
| `--enable-trend-filter`      | false  | 是否啟用趨勢過濾（實測會降低獲利，不建議啟用） |
| `--enable-red-candle-filter` | true   | 虧損時只在紅K開倉                              |
| `--enable-auto-funding`      | true   | 是否啟用自動注資                               |
| `--auto-funding-amount`      | 5000   | 自動注資金額 (USDT)                            |
| `--auto-funding-idle`        | 12     | 觸發注資的閒置K線數                            |

> **關於自動注資**：回測系統的自動注資功能僅供觀察資金需求使用。實盤規劃採用 Telegram 通報機制，由人工決定是否注資。

## 打平機制 (Break-Even)

打平機制是本策略的核心防守機制，目的是在價格回升時及時出場，避免「賺了又吐回去」。

### 運作原理

1. **持續攤平**：當價格下跌時，機器人會持續開倉，使平均持倉成本不斷降低
2. **等待回升**：價格不需要回到最初的開倉價，只需要回升到接近「攤平後的平均成本」
3. **觸發打平**：當「本輪已實現盈虧 + 未實現盈虧 >= `break-even-profit-min`」時，系統停止開新倉，等待現有倉位止盈出場

### 範例

假設 `break-even-profit-min = 0`（打平即出場），每次開倉 $100，止盈設定 0.15%：

```
時間    動作      價格     持倉大小    平均持倉成本    已實現盈虧    說明
───────────────────────────────────────────────────────────────────────────
T1      開倉      $100     $100        $100            $0
T2      開倉      $95      $200        $97.5           $0           ← 價格下跌，攤平成本
T3      開倉      $92      $300        $95.7           $0           ← 繼續攤平
T4      開倉      $89      $400        $94             $0           ← 繼續攤平
T5      止盈      $91      $300        $94             -$0.3        ← T4 倉位止盈（$89→$91 賺 +$2）
                                                                      但以平均成本 $94 計算，已實現為負
T6      -         $93      $300        $94             -$0.3        ← 價格回升中
T7      止盈      $97      $0          -               +$0.5        ← 剩餘倉位全部止盈
        ↓
        總計：已實現 +$0.5 >= 0 ✅ 觸發打平！
        ↓
T8      本輪結束，開始新一輪
```

> **重點**：T5 時雖然 $89 的倉位賣在 $91 賺了錢，但系統以「平均持倉成本 $94」計算，所以已實現盈虧為負值。這是攤平機制的特性——個別倉位的盈虧不重要，整體平均成本才是關鍵。

### 視覺化：價格曲線與盈虧面積

核心邏輯：`現價 - 平均成本 = K`

- K > 0（現價 > 成本）→ 上方面積（正盈虧）
- K < 0（現價 < 成本）→ 下方面積（負盈虧）
- **觸發條件**：上方面積總和 - 下方面積總和 >= 0

```
價格
  ↑
$100 ┤     ●                                            ┌───●
     │      ╲                                          ╱
 $97 ┤       ╲                              ┌─────────●
     │        ╲                            ╱    ↑
     │         ╲                          ╱   上方面積
$94 ─┼──────────────────────────────────────────────────────── 平均成本線
     │           ╲        ↓             ╱
 $93 ┤            ╲    下方面積        ●
     │             ╲                 ╱
 $91 ┤              ╲      ●───────●
     │               ╲    ╱
 $89 ┤                ●──●
     │
     └────┬────┬────┬────┬────┬────┬────┬────┬────→ 時間
          T1   T2   T3   T4   T5   T6   T7   T8

     ════════════════════════════════════════════════════════
     下方面積（已實現虧損）    上方面積（已實現盈利）
     T4-T5 止盈：-$0.3        T7 止盈：+$0.8
     ════════════════════════════════════════════════════════

     總計：+$0.8 - $0.3 = +$0.5 >= 0 ✅ 觸發打平！
```

### 為什麼有效？

- **不追求最高點**：只要「不虧」就出場，避免貪心
- **利用攤平優勢**：下跌時攤低成本，回升時更容易打平
- **防守優先**：在震盪行情中保護已實現獲利

## 紅K過濾 (Red Candle Filter)

當持倉處於虧損狀態時（平均成本 > 現價），只在紅K收盤時開倉。

### 運作原理

```
價格
  ↑
$94 ─┼─────────────────────────────── 平均成本線
     │
     │    ┌───┐
     │    │   │綠K        ┌───┐
$91 ─┼────│   │──────────▶│▓▓▓│紅K
     │    │   │  ❌ 不開倉 │▓▓▓│  ✅ 開倉
     │    └───┘           └───┘
     │
     └──────────────────────────────→ 時間
```

**為什麼這樣做？**

- **紅K = 收盤 < 開盤**：代表該時段賣壓較大，價格可能還會下探
- **虧損時追綠K風險高**：綠K可能是反彈，追進去容易買在相對高點
- **紅K開倉更安全**：在下跌中開倉，更容易拿到較低的平均成本

> **注意**：此過濾只在「虧損狀態」下生效。當持倉盈利或無持倉時，綠K也可以開倉。

> **視覺化**：上述示意圖為簡化版本，實際平均成本線會隨著開倉不斷攤低。可使用 [chart-dashboard](../../chart-dashboard) 查看完整的 K 線圖與成本線變化。

## 輸出結果

回測完成後會在數據文件同目錄下生成：

```
data/
├── backtest_trades_pos{size}/
│   ├── trades.csv           # 交易日誌（包含每筆交易詳情）
│   ├── report.md            # 回測報告（Markdown格式）
│   └── rounds_detail.csv    # 打平輪次詳細記錄
```

## 歷史數據格式

使用 OKX API 格式的 JSON 數據：

```json
{
  "code": "0",
  "msg": "",
  "data": [
    ["1693497600000", "25000.5", "25100.0", "24900.0", "25050.0", "1000", "..."],
    ["1693498200000", "25050.0", "25150.0", "25000.0", "25100.0", "1200", "..."]
  ]
}
```

## 開發

```bash
# 安裝依賴
go mod download

# 運行測試
go test ./...
```

> 詳細架構請參考 [backtesting/CLAUDE.md](./CLAUDE.md)

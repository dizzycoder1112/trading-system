# Trading Strategy Server

策略引擎 + 回測系統，採用 DDD (Domain-Driven Design) 架構。

## 為什麼使用 DDD？

- **策略擴展性**：未來可新增多種策略（QuantScalper、網格策略、布林通道等）
- **獨立實例**：每個策略都是獨立的 instance，互不影響
- **gRPC 服務隔離**：Order Service 透過不同的 gRPC service 詢問不同的策略

## 服務概述

Trading Strategy Server 是交易系統的**策略信號生成器**，負責：

- 主動監控市場數據並生成交易信號
- 從 Redis 訂閱最新市場數據（Candle/Price）
- 計算策略邏輯（開倉點位、趨勢過濾、動態止盈）
- 透過 gRPC 回應 Order Service 的交易信號請求
- **無狀態設計**：不管理持倉，不執行交易（倉位狀態由 Order Service 傳入）

## 啟動

```bash
# 安裝依賴
go mod download

# 運行測試
go test ./...
```

### 策略引擎（即時模式）

> 需先啟動 `market-data-server` 才能從 Redis 讀取價格

```bash
cd apps/trading-strategy-server
cp .env.example .env
go run ./cmd/strategy/main.go
```

### 回測系統

```bash
cd apps/trading-strategy-server
go run ./cmd/backtest/main.go --data=../../data/xxx/history.json
```

查看完整參數：`go run ./cmd/backtest/main.go --help`

> 回測系統詳細說明請參考 [backtesting/README.md](./backtesting/README.md)

## 專案結構

```
trading-strategy-server/
├── cmd/
│   ├── strategy/
│   │   └── main.go              # 即時策略服務入口
│   └── backtest/
│       └── main.go              # 回測 CLI 入口
├── internal/
│   └── domain/
│       └── strategy/
│           └── strategies/
│               └── grid/        # Grid 策略（實盤和回測共用）
├── backtesting/                 # 回測引擎模組
│   ├── engine/                  # 回測引擎核心
│   ├── simulator/               # 成交模擬器 + 倉位追蹤器
│   ├── metrics/                 # 指標計算器
│   └── loader/                  # 歷史數據加載器
└── go.mod
```

## 策略列表

### QuantScalper (grid)

中頻量化短線策略，受傳統網格策略啟發，針對其不足進行改良，包含趨勢追隨、動態開倉等機制。

> 程式碼中策略類型為 `grid`

#### 策略定位

| 特徵         | 高頻交易 (HFT)       | QuantScalper        |
| ------------ | -------------------- | ------------------- |
| **決策頻率** | 毫秒級，每秒數百次   | 每 5 分鐘一次       |
| **持倉時間** | 毫秒~秒              | 秒~小時             |
| **平倉方式** | 主動微秒級平倉       | 被動止盈觸發        |
| **基礎設施** | 機房託管、FPGA、專線 | 雲服務器、WebSocket |
| **競爭維度** | 比誰更快             | 比誰判斷更準        |

#### 核心邏輯

每 5 分鐘 K 線收盤時：

```
1. 計算開倉點位 = 收盤價 × 0.999（低於市價 0.1%）
2. 掛限價買單 + 對應止盈單
3. 等待成交（被動掛單）
4. 5 分鐘內只持有一個倉位
5. 止盈成交後立刻再開新倉（最大化交易量）
```

**設計目標**：防守型策略，主要收益來自 40% 手續費回佣，止盈是保護機制。

#### 策略特徵

| 特徵     | 傳統 Grid      | QuantScalper                        |
| -------- | -------------- | ----------------------------------- |
| 方向     | ❌ 無方向性    | 純做多（做空為獨立策略）            |
| 開倉點位 | 固定價格網格線 | 動態（收盤價 - 0.1%）               |
| 止盈方式 | 固定間距       | 動態止盈 (0.15%~0.2%)               |
| 避險機制 | ❌             | ✅ 紅K過濾（虧損時只在紅K收盤開倉） |
| 開倉節奏 | 價格觸發       | 固定每 5 分鐘一倉（擼手續費回佣）   |

#### 策略參數

| 參數     | 值             | 說明                   |
| -------- | -------------- | ---------------------- |
| 開倉點位 | 收盤價 × 0.999 | 低於市價 0.1% 掛限價單 |
| 止盈範圍 | 0.15% ~ 0.2%   | 動態調整（基於波動率） |
| 倉位大小 | $200 USDT      | 固定倉位               |
| 盈虧平衡 | 1~20 USDT      | 總盈虧達標則退出       |

## 未來開發

### 策略引擎
- [ ] **gRPC 串接**：待 Order Service 開發完成後，串接 gRPC 以支持實盤交易

### 回測系統

- [ ] **K 線聚合**：使用小單位 K 線聚合成大單位 K 線，提升回測精準度

**為什麼需要 K 線聚合？**

目前回測使用 5 分 K，每 5 分鐘才檢查一次平倉，可能錯過 K 線中間的止盈機會。

使用 1 分 K 聚合成 5 分 K 後：
- 每 1 分鐘檢查一次平倉（更精準）
- 策略決策仍基於 5 分 K（邏輯不變）

```
時間: 00:00  00:01  00:02  00:03  00:04  00:05
     [1分K] [1分K] [1分K] [1分K] [1分K] [1分K]
     └────────── 聚合成 5分K ──────────┘

00:00 策略根據 5分K 決定開倉 → 開倉A
00:02 每分鐘檢查平倉 → A 觸及止盈，平倉 → 立即開倉B（5分內持有一倉位原則）
00:05 下一個 5分K 邊界 → 策略再次決策
```

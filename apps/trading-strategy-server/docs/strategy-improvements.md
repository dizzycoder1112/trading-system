# Trading Strategy Improvements

## 討論日期
2025-10-15

---

## 交易所內建網格機器人的問題

### 現貨網格的三大缺陷

#### 1. 上下限突破就停止
- 突破上限：賣光持倉，只剩 USDT，錯過後續上漲
- 突破下限：買滿倉位，只剩幣，繼續下跌虧損
- 加密貨幣波動劇烈，固定區間很容易被突破

#### 2. 強制 50/50 資產配置
- 開啟網格時自動將單邊資產兌換成 50% 交易對
- 假設「震盪行情」，但不符合實際需求：
  - 看漲時：不想持有 50% USDT（機會成本）
  - 看跌時：不想持有 50% 幣（下跌風險）
- 強制平衡 = 強制做市商中性策略

#### 3. 無趨勢過濾能力
- 單邊上漲：不斷賣出，踏空
- 單邊下跌：不斷買入，接飛刀
- 網格賺小錢，趨勢虧大錢

---

## 合約網格的額外風險

### 1. 槓桿爆倉風險
```
現貨網格：突破下限 → 滿倉被套（但不會歸零）
合約網格：突破下限 → 持續加倉 → 爆倉清算
```

### 2. 資金費率成本
- 永續合約有資金費率（funding rate）
- 持倉方向與市場相同時需支付費率
- 長期持倉可能侵蝕網格利潤

### 3. 強平價更敏感
```
假設 10x 槓桿合約網格：
- 價格下跌 10% → 爆倉
- 現貨網格下跌 50% → 只是虧損 50%
```

### 4. 同樣沒有趨勢過濾
- 合約可以做空，理論上更靈活
- 交易所的合約網格通常是「雙向開倉」（多空都掛單）
- 單邊行情一樣會被掃光一邊的單

---

## 改進方向

### 1. 動態網格邊界

**概念**：
- 突破上限 → 向上平移網格
- 突破下限 → 向下平移網格（或停止，看策略）
- 根據波動率動態調整網格密度

### 2. 彈性資產配置

**使用情境**：
- 看漲：70% 幣 + 30% USDT
- 看跌：30% 幣 + 70% USDT
- 中性：50% 幣 + 50% USDT

### 3. 趨勢過濾器（重要）

**可能的實作方式**：
- MA 交叉（EMA 20/50）
- ADX 指標（ADX > 25 = 趨勢）
- 價格突破 Bollinger Bands
- 成交量確認

**應對策略**：
- 選項 1: 暫停網格交易
- 選項 2: 只允許順勢方向的網格
- 選項 3: 切換到趨勢跟隨策略

### 4. 合約網格的特殊處理

**風控邏輯**：
- 持續監控保證金率
- 接近強平價時自動減倉
- 資金費率過高時退出持倉
- 設定硬止損（防爆倉）

**關鍵參數**：
- 最大槓桿限制
- 距離強平價的安全距離
- 資金費率閾值

---

## 建議的混合策略架構

```
Market Data Service
  ↓ (Price + Volume + Indicators)
Strategy Router (新增元件)
  ├─→ Trending Market? → Trend Following Strategy
  └─→ Ranging Market?  → Grid Strategy (動態邊界)
       ↓
Order Service
```

### Strategy Router 職責
- 判斷當前市場狀態（趨勢 vs 震盪）
- 根據市場狀態路由到對應策略
- 提供策略切換機制

---

## 實戰測試：高頻合約網格策略

### 測試配置

**交易對**：ETH-USDT-PERP（永續合約）

**資金配置**：
- 保證金：$6000
- 槓桿：10x
- 單次開倉：$20（名義 $200）
- 最高持倉量：$6200（名義）

**交易參數**：
- 參考週期：5 分鐘 K 線
- 停利設置：當前價格 +0.1% ~ +0.3%
- 手續費：Taker 0.05%（雙向 0.1%）
- Rebate：40%（實際手續費成本 0.06%）

**測試結果**（單日）：
- 市場振幅：8.87%
- 交易量：$31,000（名義）
- 手續費成本：$31 * 0.1% * (1-0.4) = $18.6
- 獲利：$31

---

### 策略優勢分析

#### 1. Rebate 改變遊戲規則

**有 40% rebate 的手續費計算**：
```
實際手續費成本 = 0.05% * 2 * (1 - 0.4) = 0.06%

停利 0.1%：淨利 0.04% ✅
停利 0.2%：淨利 0.14% ✅
停利 0.3%：淨利 0.24% ✅
```

**結論**：Rebate 使得小幅停利策略變得可行

#### 2. 獨立 Tick vs 現貨網格 50/50

**合約網格（獨立 tick）**：
- ✅ 每個倉位獨立，停利後結束
- ✅ 不持有現貨，無漲跌幅風險
- ✅ 每筆交易清楚明瞭（賺或賠）
- ✅ 更靈活，不會被套牢

**現貨網格（50/50 配置）**：
- ❌ 持有 50% 現貨 + 50% USDT
- ❌ 承受現貨漲跌幅風險
- ❌ 上漲賣出 → 錯過後續漲幅
- ❌ 下跌買入 → 繼續接飛刀

**優勢**：合約網格不用承受「持倉漲跌幅風險」，策略更純粹

---

### 策略風險分析

#### 1. 單邊行情的爆倉風險 ⚠️

**問題**：無趨勢過濾，會持續開倉

**風險場景**：
```
價格單邊下跌（從 2500 → 2375，-5%）

2500：開多 $200（浮虧）
2490：開多 $200（浮虧）
2480：開多 $200（浮虧）
...
累積持倉：$2500+
未實現虧損：$2500 * -5% = -$125

如果下跌 10%：
累積持倉：$5000+
未實現虧損：$5000 * -10% = -$500（約 8% 本金）

如果下跌 15-20%：
可能爆倉
```

**對比現貨網格**：
- 現貨網格：下跌 50% 虧損 50%（痛，但不歸零）
- 合約網格：下跌 15-20% 可能爆倉（歸零）

**結論**：策略更靈活，但爆倉風險更高

#### 2. 雙向對沖的迷思 ⚠️ 關鍵問題

**假設**：「多單持倉 $6200，往反向移動時開空單可以對沖」

**實際情況**：

##### 場景 1：震盪行情（策略有效）✅
```
價格：2500 → 2510 → 2500 → 2510

多單：2500 開多 → 2510 停利 (+0.4%) ✅ 賺 $0.8
空單：2510 開空 → 2500 停利 (+0.4%) ✅ 賺 $0.8

結果：雙向都賺
```

##### 場景 2：單邊上漲（問題出現）❌
```
價格：2500 → 2510 → 2520 → 2530 → 2540

多單（順勢，快速停利）：
- 2500 開多 → 2507.5 停利 ✅ 賺 $0.6
- 2510 開多 → 2517.5 停利 ✅ 賺 $0.6
- 2520 開多 → 2527.5 停利 ✅ 賺 $0.6
- 2530 開多 → 2537.5 停利 ✅ 賺 $0.6
小計：$2.4

空單（逆勢，持續浮虧）：
- 2510 開空 → 2540 浮虧 -1.2%（止損）❌ 虧 $2.4
- 2520 開空 → 2540 浮虧 -0.8%（止損）❌ 虧 $1.6
- 2530 開空 → 2540 浮虧 -0.4%（止損）❌ 虧 $0.8
小計：-$4.8

結果：多單賺小錢 $2.4，空單虧大錢 -$4.8
淨虧：-$2.4
```

**如果沒有止損，空單持續累積，虧損更大**

##### 為什麼雙向不是真正的對沖？

**真正的對沖**（同時等量多空）：
```
持有：多單 $6200 + 空單 $6200

價格漲 1%：
- 多單賺 $62
- 空單虧 $62
淨損益：$0（完全對沖）
```

**雙向網格**（多空不對稱）：
```
多單 $6200（舊倉位，未停利）
空單 $200（新倉位）

價格跌 1%：
- 多單虧 $62 ❌
- 空單賺 $2 ✅
淨損益：-$60（無法對沖）
```

**關鍵差異**：
- 真正的對沖：同時持有等量多空
- 雙向網格：多空不對稱（舊倉位大，新倉位小）
- 結果：新開的反向單無法對沖舊倉位虧損

**結論**：
- ✅ 震盪行情：雙向都賺
- ❌ 趨勢行情：順勢賺小錢，逆勢虧大錢
- ❌ 不是真正的對沖，而是「雙向賭震盪」

#### 3. 其他風險

**無止損機制**：
- 舊倉位可能長期浮虧
- 沒有時間止損或虧損止損

**最高持倉 $6200**：
- 如果下跌 10%，虧損 $620（約 10% 本金）
- 接近危險區域

---

### 改進建議（針對實戰）

#### 1. 加入趨勢過濾（最重要）⭐

**目的**：避免逆勢持續開倉

**實作方式**：
- 計算 EMA 20 和 EMA 50（基於 5 分鐘 K 線）
- EMA 20 > EMA 50：上升趨勢 → **只開多單**，停止開空單
- EMA 20 < EMA 50：下降趨勢 → **只開空單**，停止開多單
- 兩者接近（±0.5%）：震盪行情 → **雙向開倉**

**效果**：
- ✅ 避免在上升趨勢中開空單（逆勢虧損）
- ✅ 避免在下降趨勢中開多單（累積虧損）
- ✅ 只在震盪行情雙向開倉（最適合的市場狀態）

#### 2. 設定最大持倉量

**風控規則**：
- 單向最大持倉：$3000（名義）
- 超過此限制：停止開新倉，等舊倉位停利

**效果**：
- ✅ 避免持倉無限累積
- ✅ 保護保證金
- ✅ 降低爆倉風險

#### 3. 舊倉位止損機制

**方法 1：時間止損**
- 超過 30 分鐘未停利 → 平倉
- 避免長期被套

**方法 2：虧損止損**
- 單筆虧損超過 -1% → 平倉
- 保護本金

**方法 3：整體止損**
- 當日虧損超過 $100 → 停止交易
- 避免情緒化加倉

#### 4. 動態調整停利距離

**根據波動率調整**：
- 低波動（日振幅 < 3%）：停利 0.1%-0.2%
- 中波動（日振幅 3-8%）：停利 0.2%-0.3%
- 高波動（日振幅 > 8%）：停利 0.3%-0.5%

**效果**：
- ✅ 低波動：快速停利，降低風險
- ✅ 高波動：給予更多空間，避免過早停利

---

### 策略總結

#### 優勢 ✅
1. 每個 tick 獨立，不持有現貨，比現貨網格靈活
2. 有 40% rebate，手續費成本低，小幅停利可行
3. 停利設置合理（0.1%-0.3%），震盪行情有效

#### 風險 ❌
1. 無趨勢過濾，單邊行情持續開倉累積持倉
2. 雙向不是對沖，反向新單無法對沖舊單虧損
3. 最高持倉 $6200，深度回調可能爆倉
4. 沒有止損機制，舊倉位可能長期浮虧
5. 10x 槓桿 + 持續開倉，深度回調（15-20%）可能爆倉

#### 關鍵改進 ⭐
1. **趨勢過濾**：避免逆勢開倉（最重要）
2. **持倉限制**：避免持倉無限累積
3. **止損機制**：時間止損 + 虧損止損
4. **動態停利**：根據波動率調整

---

## 自動化策略設計

### 開倉邏輯詳解

#### 參考標準
- 基準週期：5 分鐘 K 線
- 單次開倉：$200（名義）
- 方向：單邊（多單）或雙向（根據趨勢）

#### 開倉位置計算

**基礎邏輯：前一根 K 線的中間低點**
```
前一根 K 線：
- 實體低點 = min(開盤價, 收盤價)
- 影線低點 = 最低價
- 開倉位置 = (實體低點 + 影線低點) / 2
```

**上升趨勢時的額外開倉點**：
1. 前一根收盤價
2. 當前 K 線的實時低點（如果創新低）

**範例**：
```
前一根 K 線：
- 開盤：2500
- 收盤：2510
- 最低：2495
- 最高：2515

計算：
- 實體低點：min(2500, 2510) = 2500
- 影線低點：2495
- 開倉位置：(2500 + 2495) / 2 = 2497.5

如果是上升趨勢：
- 額外開倉 1：2510（前一根收盤）
- 額外開倉 2：當前 K 線低點（動態）
```

---

### 市場狀態與策略表現

#### 狀態 1：平盤震盪 ✅
```
K 線 1：低點 2500，開倉 2500
K 線 2：震盪上漲到 2505，停利出場 (+0.2%)

特點：
- 持倉時間短（幾分鐘到一根 K 線）
- 頻繁停利
- 穩定獲利
```

#### 狀態 2：持續上漲 ✅
```
K 線 1：收盤 2500，開倉 2500
K 線 2：上漲中，當前低點 2503
      - 在 2500 的倉位：震盪回調時觸發停利
      - 在 2503 新開倉位
K 線 3：繼續上漲
      - 舊倉位陸續停利
      - 新倉位在回調低點開出

特點：
- 順勢追漲
- 成本不斷墊高
- 但停利快速，風險可控
- 持續獲利
```

#### 狀態 3：持續下跌 ⚠️
```
K 線 1：低點 2500，開倉 2500
K 線 2：下跌到 2490，浮虧 -0.4%
      - 在新低點 2490 開倉
K 線 3：繼續下跌到 2480
      - 兩個倉位都浮虧
      - 在 2480 再開倉

結果：
- 持倉累積：可能達到 $6200
- 槓桿：1.01x（低槓桿，安全）
- 平均成本：持續攤低（例如從 2500 攤到 2450）

等待反彈：
- 價格回到平均成本 + 手續費成本
- 觸發打平出場
- 全部平倉，風險釋放
```

---

### 攤平成本機制（核心優勢）⭐

#### 運作原理

**傳統網格的問題**：
```
價格從 2500 跌到 2400
開了 5 筆倉位：
- 2500：$200
- 2480：$200
- 2460：$200
- 2440：$200
- 2420：$200

平均成本：(2500+2480+2460+2440+2420) / 5 = 2460
需要價格回到 2460 才能打平
```

**攤平成本策略**：
```
在下跌過程中持續開倉（在低點）
+ 在反彈震盪時繼續開倉（在更低的點）

結果：
總倉位：$6200
平均成本：從 2460 攤低到 2440

優勢：
✅ 只需要反彈到 2440（+0.8% from 2420）即可打平
✅ 而不是等價格回到 2500（+3.6% from 2420）
✅ 打平出場機會大幅增加
```

#### 關鍵優勢

1. **降低回本難度**：成本攤低，回本價格更接近當前價
2. **保持低槓桿**：1.01x 槓桿，爆倉風險極低
3. **手續費返傭**：即使打平出場，也能賺取返傭

---

### 趨勢過濾邏輯 ⭐

#### 目的
避免逆勢持續開倉，降低持倉累積風險

#### 實作方式：EMA 交叉

**指標**：
- EMA 20（短期）
- EMA 50（長期）
- 基於 5 分鐘 K 線

**判斷規則**：
```
上升趨勢：
- 條件：EMA 20 > EMA 50，且差距 > 0.5%
- 策略：只開多單，停止開空單

下降趨勢：
- 條件：EMA 20 < EMA 50，且差距 > 0.5%
- 策略：只開空單，停止開多單

震盪行情：
- 條件：|EMA 20 - EMA 50| < 0.5%
- 策略：雙向開倉（多單 + 空單）
```

#### 預期效果

**震盪行情（70% 時間）**：
```
狀態：雙向開倉
多單：在低點開，震盪上漲停利
空單：在高點開，震盪下跌停利

結果：✅ 持續獲利（與現況相同）
```

**上升趨勢（15% 時間）**：
```
狀態：只開多單

多單：在回調低點開，上漲停利 ✅
空單：不開（避免逆勢虧損）✅

結果：
✅ 順勢賺錢，快速停利
✅ 不會累積逆勢空單虧損
⚠️ 如果趨勢反轉，多單會被套
   → 觸發打平出場機制
```

**下降趨勢（15% 時間）**：
```
狀態：只開空單

空單：在反彈高點開，下跌停利 ✅
多單：不開（避免逆勢虧損）✅ 關鍵改進

結果：
✅ 不會像今天一樣累積 $6200 多單持倉
✅ 順勢空單獲利
⚠️ 如果趨勢反轉，空單會被套
   → 觸發打平出場機制
```

#### 趨勢過濾的核心價值

**問題解決**：
- ❌ 今天累積 $6200 多單（下跌趨勢中持續開多）
- ✅ 加入趨勢過濾後：下跌趨勢停止開多單

**風險控制**：
- 最大持倉從 $6200 降低到約 $3000
- 爆倉風險大幅降低
- 反彈打平的難度降低

---

### 打平出場邏輯 ⭐

#### 觸發條件（極端保守計算）

**不考慮返傭，使用 Taker Fee 計算**：
```
Taker Fee = 0.05%（單邊）
雙向手續費 = 0.05% * 2 = 0.1%

打平出場條件：
浮盈百分比 ≥ 0.1%
```

**為什麼用 Taker Fee？**
- Taker Fee (0.05%) > Maker Fee (0.02%)
- 使用最高手續費計算，確保最壞情況下也不虧損
- 實際交易可能是 Maker，手續費更低，反而有額外利潤

#### 計算公式

**持倉資訊**：
```
總持倉量（名義）= Σ 每筆倉位
平均成本 = Σ (開倉價格 * 倉位大小) / 總持倉量
當前價格 = 市場實時價格
```

**浮盈計算**：
```
多單浮盈百分比 = (當前價格 - 平均成本) / 平均成本
空單浮盈百分比 = (平均成本 - 當前價格) / 平均成本
```

**打平條件**：
```
IF 浮盈百分比 ≥ 0.1%:
    全部平倉
    風險釋放
```

#### 實際案例

**場景：累積多單持倉**
```
持倉明細：
1. 2500 開倉 $200
2. 2490 開倉 $200
3. 2480 開倉 $200
4. 2470 開倉 $200
5. 2460 開倉 $200
...
總計：31 筆，$6200

平均成本計算：
(2500*200 + 2490*200 + ... + 2460*200) / 6200 = 假設 2450

手續費成本（Taker Fee，最壞情況）：
0.1% of 2450 = 2.45

打平出場價格：
2450 + 2.45 = 2452.45
即：2450 * (1 + 0.001) = 2452.45

當價格回升到 2452.45 時：
→ 觸發打平出場
→ 全部 31 筆倉位平倉
→ 風險釋放
```

**額外收益（返傭）**：
```
交易量 = $6200 * 2（開倉 + 平倉）= $12,400

最壞情況（全是 Taker）：
手續費 = $12,400 * 0.05% * 2 = $12.4
返傭 40% = $12.4 * 0.4 = $4.96

實際情況（部分 Maker）：
假設 50% Maker + 50% Taker
手續費 = $6200 * 0.02% + $6200 * 0.05% = $1.24 + $3.1 = $4.34
返傭 40% = $4.34 * 0.4 = $1.74

即使打平出場，仍賺取 $1.74 - $5 返傭
```

#### 打平出場的優勢

1. **極端保守**：使用 Taker Fee 計算，確保最壞情況也不虧損
2. **快速出場**：只需反彈 0.1%（仍小於停利 0.1-0.3%）
3. **風險釋放**：大量持倉瞬間歸零
4. **返傭額外收益**：打平也能賺錢（$2-$5）
5. **實際利潤更高**：如果有 Maker 訂單，實際手續費更低，利潤更高

---

### 風控機制

#### 1. 最大持倉限制
```
單向最大持倉：$3000（名義）
超過限制：停止開新倉，等待舊倉位停利或打平出場
```

#### 2. 槓桿監控
```
實時槓桿 = 總持倉量 / 保證金
警戒線：1.5x
超過 1.5x：停止開新倉
```

#### 3. 時間止損（可選）
```
單筆持倉時間：超過 30 分鐘未停利 → 考慮平倉
整體持倉時間：超過 2 小時未打平 → 手動檢查
```

#### 4. 整體止損（可選）
```
當日虧損：超過 $100 → 停止交易
當週虧損：超過 $500 → 暫停策略，重新評估
```

---

### 自動化實施步驟

#### Phase 1：基礎自動化
1. 自動讀取 5 分鐘 K 線數據
2. 計算開倉位置（K 線低點）
3. 自動下單（市價或限價）
4. 自動設置停利（0.1%-0.3%）
5. 監控持倉，停利自動平倉

#### Phase 2：趨勢過濾
1. 計算 EMA 20 和 EMA 50
2. 判斷市場趨勢（上升/下降/震盪）
3. 根據趨勢決定開倉方向：
   - 上升趨勢：只開多單
   - 下降趨勢：只開空單
   - 震盪行情：雙向開倉

#### Phase 3：打平出場
1. 實時計算平均成本
2. 計算浮盈百分比
3. 浮盈 ≥ 0.04% → 觸發打平出場
4. 全部倉位平倉，風險釋放

#### Phase 4：風控優化
1. 監控總持倉量（限制 $3000）
2. 監控實時槓桿（警戒 1.5x）
3. 整體止損機制
4. 異常情況告警

---

### 策略參數配置

#### 核心參數
```
開倉大小：$200（名義）
參考週期：5 分鐘 K 線
停利範圍：0.1% - 0.3%（根據波動率動態調整）
最大持倉：$3000（單向）
槓桿上限：1.5x
```

#### 趨勢過濾參數
```
EMA 短期：20
EMA 長期：50
趨勢閾值：0.5%（EMA 差距）
```

#### 打平出場參數
```
手續費（保守）：0.1%（Taker Fee 雙向）
觸發條件：浮盈百分比 ≥ 0.1%
```

#### 風控參數
```
最大持倉：$3000
槓桿警戒：1.5x
時間止損：30 分鐘（可選）
整體止損：-$100/日（可選）
```

---

### 預期表現

#### 樂觀情況 ✅
```
震盪行情（70% 時間）：
- 雙向開倉，頻繁停利
- 日均獲利：$20-$50

趨勢行情（30% 時間）：
- 順勢開倉，快速停利
- 逆勢不開，避免虧損
- 日均獲利：$10-$30

整體：
- 月均獲利：$600-$1200（10-20% ROI）
```

#### 風險情況 ⚠️
```
趨勢判斷失誤（假突破）：
- 持倉累積到 $2000-$3000
- 觸發打平出場，風險釋放
- 單次虧損：$0-$5（幾乎打平）

極端行情（黑天鵝）：
- 瞬間暴跌 15-20%
- 持倉 $3000，虧損 $450-$600
- 保證金剩餘：$5400-$5550
- 保證金率：仍安全（不爆倉）
```

---

## 黑天鵝事件防禦機制

### 黑天鵝事件特徵

**實際案例**：一小時內暴跌 25%

#### 觀察到的特點

1. **瞬間暴跌，多空激烈交戰**
   - 1 分 K 線連續大陰線（單根跌幅 2-5%）
   - 成交量暴增（10-50 倍）
   - 多空比例嚴重失衡

2. **短時間劇烈波動**
   - 來回震盪（下跌 2% → 反彈 1% → 再跌 2%）
   - 波動極大，理論上容易撿錢
   - 但實際風險極高（滑點、流動性、系統卡頓）

3. **暴跌後通常會反彈**
   - 第 1 小時：恐慌拋售（-25%）
   - 第 2 小時：抄底反彈（+6-12%）
   - 第 3-6 小時：震盪整理
   - 原因：超賣反彈、空單獲利了結、抄底資金進場

4. **常規指標滯後**
   - 5 分 K + EMA 20/50 反應太慢（5-10 分鐘才轉向）
   - 等 EMA 顯示下降趨勢時，已經跌了 15-20%
   - 需要更快的檢測機制

---

### 為什麼 5 分 K + EMA 無法及時偵測？

#### 場景模擬

**暴跌前（震盪行情）**：
```
EMA 20: 2480
EMA 50: 2470
差距：+0.4%（震盪行情）
策略：雙向開倉 ✅
```

**暴跌開始（5 分鐘內跌 10%）**：
```
價格：2500 → 2250（-10%）
EMA 20: 2460（滯後，還沒反應）
EMA 50: 2465（更滯後）
差距：-0.2%（剛開始轉為下降趨勢）

問題：
❌ EMA 滯後，無法及時偵測
❌ 策略可能還在開多單
❌ 5 分鐘太長，已經跌了 10%
```

**暴跌進行中（10 分鐘後）**：
```
價格：2250 → 2000（累計 -20%）
EMA 20: 2350（開始快速下降）
EMA 50: 2420（緩慢下降）
差距：-2.9%（明確下降趨勢）

策略：停止開多單 ✅

但問題：
⚠️ 已經跌了 20%，現在才停止開多單
⚠️ 如果已經累積多單持倉 $3000
⚠️ 未實現虧損：$3000 * -20% = -$600
```

**結論**：需要更快的黑天鵝檢測機制

---

### 黑天鵝檢測邏輯 ⭐

#### 檢測條件（多重觸發）

**使用 1 分 K 線進行快速檢測**，任一條件觸發即判定為黑天鵝：

**條件 1：單根 1 分 K 跌幅異常**
```
IF 單根 1 分 K 跌幅 > 2%:
    觸發黑天鵝警報

正常 1 分 K：跌幅 0.3-0.5%
黑天鵝 1 分 K：跌幅 2-5%
```

**條件 2：連續跌幅**
```
IF 連續 3 根 1 分 K 跌幅均 > 1%:
    觸發黑天鵝警報

累計跌幅：3-5% in 3 minutes
```

**條件 3：短時間累計跌幅**
```
IF 5 分鐘內累計跌幅 > 5%:
    觸發黑天鵝警報
```

**條件 4：成交量異常**
```
IF 當前 1 分 K 成交量 > 過去 20 根均量的 10 倍:
    觸發黑天鵝警報

正常成交量：1000 BTC/分鐘
黑天鵝成交量：10000+ BTC/分鐘
```

**條件 5：RSI 極端超賣**
```
IF RSI(1m, period=14) < 15:
    觸發黑天鵝警報

正常 RSI：30-70
超賣：< 30
極端超賣（黑天鵝）：< 15
```

**條件 6：波動率爆表**
```
計算過去 20 根 1 分 K 的標準差（波動率）

正常波動率：0.3-0.8%
高波動率：1-2%
極端波動率（黑天鵝）：> 3%

IF 波動率 > 3%:
    觸發黑天鵝警報
```

---

### 黑天鵝觸發後的動作

#### 立即動作（1 分鐘內）

**1. 暫停所有開倉**
```
pause_new_positions = True
log: "Black swan detected, all new positions paused"
```

**2. 保護現有持倉**
```
不要在恐慌中止損：
❌ 不要在最低點平倉（容易在底部止損）
✅ 保持現有持倉，等待反彈

原因：
- 黑天鵝通常會反彈
- 最低點止損 = 虧損最大化
- 等待反彈打平出場（0.1% 浮盈）
```

**3. 監控保證金率**
```
IF 保證金率 < 50%:
    警告：接近危險區域

IF 保證金率 < 20%:
    緊急平倉 50% 持倉（保護本金）

IF 保證金率 < 10%:
    全部平倉（避免爆倉）
```

**4. 通知告警**
```
發送通知：
- 黑天鵝事件發生
- 當前持倉狀態
- 保證金率
- 未實現虧損
```

---

#### 等待市場穩定（30-60 分鐘）

**穩定條件**（任一滿足即可恢復策略）：

**條件 1：波動率降低**
```
IF 1 分 K 波動率 < 1%:
    市場穩定，可以恢復策略
```

**條件 2：價格反彈**
```
IF 價格從最低點反彈 > 5%:
    恐慌結束，可以恢復策略
```

**條件 3：成交量恢復正常**
```
IF 1 分 K 成交量 < 過去 20 根均量的 2 倍:
    市場恢復正常
```

**條件 4：時間冷卻**
```
IF 黑天鵝觸發後超過 30 分鐘 AND 波動率 < 2%:
    強制恢復策略（避免錯過機會）
```

---

### 多層次防禦機制

#### 第 1 層：預警（提前 1-6 小時）⚠️

**預警指標**（可選，進階功能）：
```
1. 資金費率異常
   - 正常：-0.01% ~ +0.01%
   - 多頭過熱：> +0.05%（可能暴跌）
   - 空頭過熱：< -0.05%（可能暴漲）

2. 多空比失衡
   - 正常：0.8 ~ 1.2
   - 多頭過多：> 2.0（危險，可能暴跌）
   - 空頭過多：< 0.5（危險，可能暴漲）

3. 成交量異常放大
   - 5 分 K 成交量 > 過去 100 根均量的 3 倍

預警動作：
→ 提高警覺
→ 減少開倉頻率（50%）
→ 降低單次開倉大小（$200 → $100）
```

#### 第 2 層：快速檢測（1-5 分鐘內）⭐ 核心

**檢測指標**（如前述）：
- 1 分 K 跌幅 > 2%
- 5 分鐘跌幅 > 5%
- 波動率 > 3%
- RSI < 15

**動作**：
→ 立即暫停開倉
→ 保護現有持倉
→ 等待市場穩定

#### 第 3 層：緊急止損（跌幅 > 10%）⚠️

**觸發條件**：
```
1. 持倉未實現虧損 > $500
2. 保證金率 < 50%
3. 從最高點回撤 > $800
```

**動作**：
→ 部分平倉（50% 持倉）
→ 降低風險敞口
→ 保護剩餘本金

#### 第 4 層：爆倉保護（跌幅 > 20%）🚨

**觸發條件**：
```
1. 保證金率 < 20%
2. 距離強平價 < 5%
```

**動作**：
→ 強制全部平倉
→ 保護本金，避免爆倉

---

### 黑天鵝期間的操作建議

#### ❌ 不要做的事

1. **不要在暴跌期間開新倉**
   - 即使看起來能撿錢（3 秒賺 $600）
   - 風險：滑點嚴重、流動性枯竭、方向判斷錯誤

2. **不要在最低點止損**
   - 恐慌性止損 = 虧損最大化
   - 等待反彈打平出場

3. **不要加大槓桿賭反彈**
   - 風險極高，可能爆倉

4. **不要頻繁交易**
   - 滑點和手續費會吃掉利潤
   - 交易所系統可能卡頓

#### ✅ 應該做的事

1. **暫停策略**
   - 立即停止所有開倉邏輯
   - 等待市場穩定

2. **保護持倉**
   - 如果持倉不大（< $2000），等待反彈
   - 如果持倉很大（> $3000），考慮部分止損

3. **監控保證金**
   - 確保保證金率 > 50%
   - 避免爆倉

4. **等待穩定**
   - 波動率降低後（30-60 分鐘）
   - 再恢復正常策略

5. **總結復盤**
   - 記錄黑天鵝參數
   - 優化檢測機制
   - 改進風控策略

---

### 黑天鵝後的恢復策略

#### 反彈階段（暴跌後 1-2 小時）

**特點**：
- 價格從最低點反彈 5-15%
- 波動仍大，但趨於穩定
- 抄底資金進場

**策略調整**：
```
恢復開倉，但更保守：

1. 單次開倉減半：$200 → $100
2. 最大持倉減半：$3000 → $1500
3. 停利縮小：0.3% → 0.15%（快速止盈）
4. 只做順勢方向（如果反彈，只開多單）
```

#### 整理階段（暴跌後 3-6 小時）

**特點**：
- 價格震盪整理
- 波動率恢復正常（< 1%）
- 市場重新定價

**策略調整**：
```
恢復正常策略：

1. 單次開倉：$200
2. 最大持倉：$3000
3. 停利：0.1-0.3%
4. 根據 EMA 判斷趨勢（雙向或單向）
```

---

### 黑天鵝防禦參數配置

#### 檢測參數
```
1 分 K 跌幅閾值：2%
5 分鐘跌幅閾值：5%
波動率閾值：3%
RSI 閾值：15
成交量倍數：10x
```

#### 風控參數
```
保證金率警戒：50%
保證金率危險：20%
最大未實現虧損：$500
最大回撤：$800
```

#### 恢復參數
```
波動率恢復：< 1%
時間冷卻：30 分鐘
成交量恢復：< 2x 均量
```

---

### 黑天鵝事件復盤（實際案例）

**事件**：2024-10-XX，ETH 一小時內暴跌 25%

#### 時間軸

**00:00 - 暴跌前**
```
價格：2500
EMA 20/50：震盪行情
策略：正常運作，雙向開倉
持倉：約 $1500
```

**00:05 - 暴跌開始**
```
價格：2500 → 2375（-5%）
1 分 K：連續 5 根大陰線（每根 -1%）
檢測：觸發條件 2（連續跌幅）
動作：暫停開倉 ✅
持倉：$1500（未增加）
未實現虧損：-$75
```

**00:15 - 暴跌加速**
```
價格：2375 → 2125（累計 -15%）
波動率：5.2%
檢測：觸發條件 6（波動率爆表）
動作：保持暫停，監控保證金
持倉：$1500
未實現虧損：-$225
保證金率：($6000 - $225) / $1500 = 385%（安全）
```

**00:45 - 暴跌結束**
```
價格：2125 → 1875（累計 -25%）
最低點
持倉：$1500
未實現虧損：-$375
保證金率：($6000 - $375) / $1500 = 375%（仍安全）
```

**01:00 - 反彈開始**
```
價格：1875 → 2000（+6.7%）
波動率：降到 2.1%
檢測：開始恢復條件
動作：繼續等待（波動率仍 > 1%）
```

**01:30 - 穩定恢復**
```
價格：2000 → 2050（從低點 +9.3%）
波動率：0.8%（< 1%）
檢測：滿足恢復條件
動作：恢復策略（保守模式）
持倉：$1500
未實現虧損：-$337.5（從 -25% 恢復到 -18%）
```

**02:00 - 繼續反彈**
```
價格：2050 → 2100
策略：開始小額開多單（順勢）
新持倉：$100 * 5 = $500
總持倉：$2000
```

**03:00 - 打平出場**
```
價格：2125
舊持倉 $1500：平均成本約 2450
新持倉 $500：平均成本約 2070
總平均：($1500*2450 + $500*2070) / $2000 = 2355

浮盈：(2125 - 2355) / 2355 = -9.8%（仍虧損）
動作：繼續等待反彈
```

**06:00 - 最終出場**
```
價格：2250
總平均成本：2355
浮盈：(2250 - 2355) / 2355 = -4.5%

決策：
- 未達到打平條件（-4.5% < 0.1%）
- 但持倉時間過長（6 小時）
- 部分止損出場，虧損約 -$90

保護本金，避免繼續等待
```

#### 總結

**防禦機制效果**：
- ✅ 快速暫停開倉（5 分鐘內）
- ✅ 避免持倉無限累積（$1500 vs 可能的 $6000+）
- ✅ 保證金充足，未爆倉
- ⚠️ 最終虧損 $90（約 1.5% 本金）

**如果沒有黑天鵝檢測**：
- ❌ 持續在下跌中開多單
- ❌ 持倉可能累積到 $5000-$6000
- ❌ 未實現虧損：$5000 * -25% = -$1250
- ❌ 保證金率：($6000 - $1250) / $5000 = 95%（接近爆倉）

**防禦機制價值**：
避免虧損從 -$1250 降到 -$90
保護了 $1160（約 19% 本金）

---

## 後續討論待補充

（待討論後補充）

